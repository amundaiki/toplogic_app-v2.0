<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopLogic - Fakturaopplasting</title>
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/67a10d12887082593bb5d293/d39dc0a0-5a17-4ef9-88a4-2d0edb45fd5e/LOGO+l.png?format=500w">
    <link rel="stylesheet" href="../../styles/shared.css">
    <link rel="stylesheet" href="../../styles/advanced-paths.css">
    <link rel="stylesheet" href="../../styles/micro-interactions.css">
    <link rel="stylesheet" href="../../styles/cleanup-overrides.css">
    <link rel="stylesheet" href="../../styles/enhanced-selects.css">
    <!-- <link rel="stylesheet" href="../../styles/custom-dropdown.css"> -->
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- <script src="../../utils/custom-dropdown.js"></script> -->
    
    <style>
        .shipment-count-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-sm);
        }
        
        .shipment-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--color-gray-border);
            background: white;
            color: var(--color-gray-dark);
            border-radius: var(--radius-md);
            font-size: var(--font-size-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
        }
        
        .shipment-btn:hover {
            border-color: var(--color-blue);
            color: var(--color-blue);
            background: var(--color-blue-light);
        }
        
        .shipment-btn.selected {
            border-color: var(--color-blue);
            background: var(--color-blue);
            color: white;
        }
        
        .shipment-btn.selected:hover {
            background: var(--color-blue-dark);
            border-color: var(--color-blue-dark);
        }
        
        @media (max-width: 768px) {
            .shipment-count-buttons {
                gap: var(--spacing-xs);
            }
            
            .shipment-btn {
                flex: 1;
                min-width: auto;
                font-size: var(--font-size-xs);
                padding: var(--spacing-xs) var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="toplogic-container">
            <div class="toplogic-header toplogic-header-ai">
                <img src="https://www.toplogic.no/wp-content/uploads/2023/01/Toplogic_norge_logo.svg" alt="TopLogic logo" class="header-logo" />
                <h1>Fakturaopplasting</h1>
                <p>Velg hvem som laster opp, velg leverand√∏r og eventuelt hvilke parametre du √∏nsker √• hente ut. Last deretter opp √©n eller flere PDF-fakturaer. Du vil motta en e-post med Excel-filen(e) n√•r prosesseringen er ferdig.</p>
            </div>
            
            <div class="toplogic-content">
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="opplaster" class="form-label">
                            <i data-lucide="user" class="form-label-icon"></i>
                            Hvem laster opp?
                        </label>
                        <div class="custom-select-wrapper">
                            <select id="opplaster" name="opplaster" class="form-select enhanced-select" required>
                                <option value="">Velg opplaster...</option>
                                <!-- Vil bli populert via JavaScript -->
                            </select>
                            <i data-lucide="chevron-down" class="select-arrow"></i>
                        </div>
                    </div>

                    <div class="form-group" id="shipmentCountSection" style="display: none !important;">
                        <label class="form-label">
                            <i data-lucide="package" class="form-label-icon"></i>
                            Ansl√•tt antall sendinger i fakturaen
                        </label>
                        <p style="color: var(--color-gray-medium); font-size: var(--font-size-small); margin: var(--spacing-xs) 0;">
                            Hjelper systemet med √• prosessere fakturaen optimalt ved √• dele den i passende seksjoner.
                        </p>
                        <div class="shipment-count-buttons" id="shipmentCountButtons">
                            <button type="button" class="shipment-btn" data-count="1-30">1-30</button>
                            <button type="button" class="shipment-btn" data-count="31-60">31-60</button>
                            <button type="button" class="shipment-btn" data-count="61-100">61-100</button>
                            <button type="button" class="shipment-btn" data-count="101-150">101-150</button>
                            <button type="button" class="shipment-btn" data-count="150+">150+</button>
                        </div>
                        <input type="hidden" id="shipmentCount" name="shipmentCount">
                    </div>

                    <div class="form-group" id="standardMalInfo">
                        <div style="padding: var(--spacing-md); background: var(--color-blue-light); border-radius: var(--radius-md); border-left: 4px solid var(--color-blue);">
                            <h4 style="color: var(--color-blue-dark); margin: 0 0 var(--spacing-sm) 0; font-size: var(--font-size-normal); font-weight: 600;">TopLogic Standardisert mal</h4>
                            <p style="color: var(--color-gray-dark); margin: 0 0 var(--spacing-sm) 0; font-size: var(--font-size-normal); line-height: 1.5;">
                                Bruker TopLogics standardiserte mal som automatisk henter ut 133 parametre fra fakturaen og plasserer alle p√• samme rad i Excel-filen.
                            </p>
                            <p style="color: var(--color-gray-dark); margin: 0 0 var(--spacing-sm) 0; font-size: var(--font-size-normal); line-height: 1.5;">
                                <strong>Eksempel p√• parametre som hentes:</strong><br>
                                Leverand√∏r (FedEx), Fakturanummer (INV-123456), Fakturadato (2025-01-15), Avgang (Stockholm), Ankomst (Oslo), Vekt (25.5 kg), Antall kolli (3), Frakt (850 SEK), Br√§nslekostnad (125 SEK), osv.
                            </p>
                            <p style="color: var(--color-gray-medium); margin: 0; font-size: var(--font-size-normal); line-height: 1.5;">
                                Malen gjenkjenner automatisk terminologi fra alle store transport√∏rer (FedEx, DHL, Bring, PostNord, UPS, DB Schenker, etc.) og strukturerer informasjonen til et standardisert format.
                            </p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fakturaFile" class="form-label">Last opp fakturaer</label>
                        <div class="file-upload-area" id="dropZone">
                            <input type="file" id="fakturaFile" name="fakturaFile" accept=".pdf" multiple required>
                            <svg class="upload-icon" viewBox="0 0 24 24">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            <p><strong>Klikk for √• velge filer</strong> eller dra og slipp her</p>
                            <p class="supported-formats">St√∏ttet format: PDF ‚Ä¢ Du kan velge flere fakturaer samtidig</p>
                        </div>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div style="background: var(--color-gray-light); padding: var(--spacing-md); border-radius: var(--radius-md); margin-top: var(--spacing-sm);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                    <h4 style="margin: 0; color: var(--color-gray-dark); font-size: var(--font-size-small); font-weight: 600;">Valgte fakturaer</h4>
                                    <span id="fileCount" style="background: var(--color-blue); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: 500;">0 filer</span>
                                </div>
                                <div id="fileList" style="max-height: 150px; overflow-y: auto;">
                                    <!-- Fil-liste vil bli populert via JavaScript -->
                                </div>
                                <button type="button" id="clearFiles" style="margin-top: var(--spacing-sm); background: none; border: 1px solid var(--color-gray-border); color: var(--color-gray-medium); padding: 4px 12px; border-radius: var(--radius-sm); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s ease;">
                                    Fjern alle filer
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full btn-large" id="submitBtn">
                        <span>Send fakturaer</span>
                        <div class="loading-spinner" id="loadingSpinner"></div>
                    </button>

                    <button type="button" class="btn btn-secondary btn-full mt-lg" id="resetBtn">
                        Nullstill
                    </button>
                </form>

                <div class="message" id="message"></div>

                <!-- AI Disclaimer -->
                <div style="text-align: center; margin-top: var(--spacing-xxxl); padding: var(--spacing-md); color: #6b7280; font-size: 0.75rem; opacity: 0.7;">
                    AI-generert resultat: Innholdet er laget av kunstig intelligens og kan inneholde feil. Vennligst kontroller resultatet f√∏r bruk.
                </div>
            </div>
        </div>
    </div>

    <!-- Last inn konfigurasjon og delt funksjonalitet (ES6 modules) -->
    <script type="module" src="../../legacy.js"></script>
    <!-- <script type="module" src="../../utils/scroll-animations.js"></script> -->
    
    <script>
        // Vent til DOM og ES6 modules er lastet
        document.addEventListener('DOMContentLoaded', function() {
            // Vent litt ekstra for at ES6 modules skal v√¶re helt klare
            setTimeout(() => {
                // Initialiser TopLogic App
                const app = new TopLogicApp();
                const config = window.TopLogicConfig;

                if (!config || !config.APP_CONFIG) {
                    console.error('TopLogicConfig not loaded yet');
                    return;
                }

                // Populer dropdown-menyer fra config
                function populateDropdowns() {
                    const opplasterSelect = document.getElementById('opplaster');

                    // Populer brukere
                    config.APP_CONFIG.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.value;
                        option.textContent = user.label;
                        opplasterSelect.appendChild(option);
                    });
                }

                // Initialiser komponenter
                populateDropdowns();

                // Setup shipment count buttons
                function setupShipmentCountButtons() {
                    const buttons = document.querySelectorAll('.shipment-btn');
                    const hiddenInput = document.getElementById('shipmentCount');
                    
                    buttons.forEach(button => {
                        button.addEventListener('click', function() {
                            // Fjern selected fra alle knapper
                            buttons.forEach(btn => btn.classList.remove('selected'));
                            
                            // Legg til selected p√• valgt knapp
                            this.classList.add('selected');
                            
                            // Sett verdien i hidden input
                            hiddenInput.value = this.getAttribute('data-count');
                            
                            console.log('Antall sendinger valgt:', hiddenInput.value);
                        });
                    });
                }
                
                setupShipmentCountButtons();

                // Setup opplaster change event for conditional shipment count
                function setupOpplasterConditionalLogic() {
                    const opplasterSelect = document.getElementById('opplaster');
                    const shipmentSection = document.getElementById('shipmentCountSection');
                    const shipmentInput = document.getElementById('shipmentCount');
                    
                    opplasterSelect.addEventListener('change', function() {
                        const selectedUser = this.value;
                        console.log('Opplaster endret til:', selectedUser);
                        
                        if (selectedUser === 'Amund') {
                            // Vis sendinger-seksjonen og gj√∏r den obligatorisk
                            shipmentSection.style.setProperty('display', 'block', 'important');
                            shipmentInput.setAttribute('required', 'required');
                        } else {
                            // Skjul sendinger-seksjonen og fjern required
                            shipmentSection.style.setProperty('display', 'none', 'important');
                            shipmentInput.removeAttribute('required');
                            
                            // Reset valg hvis skjult
                            document.querySelectorAll('.shipment-btn').forEach(btn => btn.classList.remove('selected'));
                            shipmentInput.value = '';
                        }
                    });
                }
                
                setupOpplasterConditionalLogic();
                
                // S√∏rg for at sendinger-seksjonen er skjult ved oppstart
                function initializeShipmentCountVisibility() {
                    const shipmentSection = document.getElementById('shipmentCountSection');
                    if (shipmentSection) {
                        shipmentSection.style.setProperty('display', 'none', 'important');
                        console.log('Sendinger-seksjon skjult ved oppstart');
                    }
                }
                
                initializeShipmentCountVisibility();

                // Custom dropdowns midlertidig deaktivert
                // const opplasterDropdown = new CustomDropdown(document.getElementById('opplaster'), {
                //     placeholder: 'Velg opplaster...'
                // });

                // DOM elementer

                // Setup file upload med st√∏tte for flere filer
                let selectedFiles = [];
                app.setupFileUpload('fakturaFile', {
                    allowedTypes: 'pdf',
                    onFileSelect: (files) => {
                        selectedFiles = Array.isArray(files) ? files : [files];
                        console.log('Fakturaer valgt:', selectedFiles.map(f => f.name));
                        
                        // Oppdater knapp-tekst basert p√• antall filer
                        const submitBtn = document.querySelector('#submitBtn span');
                        if (selectedFiles.length === 1) {
                            submitBtn.textContent = 'Send faktura';
                        } else {
                            submitBtn.textContent = `Send ${selectedFiles.length} fakturaer`;
                        }
                    },
                    onValidationError: (error) => {
                        app.showMessage(error, 'error');
                    }
                });

                // H√•ndter "Fjern alle filer" knapp
                document.getElementById('clearFiles').addEventListener('click', function() {
                    selectedFiles = [];
                    document.getElementById('fakturaFile').value = '';
                    document.getElementById('fileInfo').style.display = 'none';
                    document.querySelector('#submitBtn span').textContent = 'Send fakturaer';
                    app.showMessage('Alle filer fjernet', 'info', 2000);
                });

                // Form submission for flere fakturaer
                document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const opplaster = document.getElementById('opplaster').value;
                    const leverandor = 'standardisert_mal'; // Alltid bruk standardisert mal
                    const shipmentCount = document.getElementById('shipmentCount').value;

                    // Valider required felter med config-meldinger
                    if (!opplaster) {
                        app.showMessage(config.APP_CONFIG.messages.error.noUser, 'error');
                        return;
                    }

                    // Valider shipment count kun hvis Amund er valgt
                    if (opplaster === 'Amund' && !shipmentCount) {
                        app.showMessage('Vennligst velg ansl√•tt antall sendinger i fakturaen', 'error');
                        return;
                    }

                    if (!selectedFiles || selectedFiles.length === 0) {
                        app.showMessage(config.APP_CONFIG.messages.error.noFile, 'error');
                        return;
                    }

                    // Start loading state
                    app.setLoadingState(true);
                    
                    const totalFiles = selectedFiles.length;
                    let completedFiles = 0;
                    let failedFiles = [];
                    let successfulFiles = [];

                    app.showMessage(`Laster opp ${totalFiles} fakturaer... Hver faktura sendes individuelt til behandling.`, 'success');

                    // Send hver faktura separat
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        
                        try {
                            const formData = new FormData();
                            
                            // Bygg FormData for denne filen
                            formData.append('file', file);
                            formData.append('opplaster', opplaster);
                            formData.append('leverandor', leverandor);
                            
                            // Kun legg til shipmentCount hvis Amund er valgt
                            if (opplaster === 'Amund' && shipmentCount) {
                                formData.append('shipmentCount', shipmentCount);
                            }
                            
                            formData.append('fileName', file.name);
                            formData.append('timestamp', config.CONFIG_HELPERS.getTimestamp());
                            formData.append('fileNumber', `${i + 1} av ${totalFiles}`);

                            // Oppdater melding for hvilken fil som behandles
                            app.showMessage(`Behandler faktura ${i + 1} av ${totalFiles}: ${file.name}`, 'success');

                            // Send til Make.com
                            await app.submitForm(formData, 'faktura', {
                                onStart: () => {
                                    console.log(`Sender faktura ${i + 1}/${totalFiles}: ${file.name}`);
                                },
                                onProgress: (progress) => {
                                    const overallProgress = ((completedFiles * 100) + progress) / totalFiles;
                                    app.setProgress(overallProgress);
                                },
                                onSuccess: (message) => {
                                    successfulFiles.push(file.name);
                                    completedFiles++;
                                    console.log(`‚úÖ Faktura ${i + 1}/${totalFiles} sendt: ${file.name}`);
                                },
                                onError: (error) => {
                                    failedFiles.push({name: file.name, error: error});
                                    completedFiles++;
                                    console.log(`‚ùå Faktura ${i + 1}/${totalFiles} feilet: ${file.name} - ${error}`);
                                }
                            });

                        } catch (error) {
                            failedFiles.push({name: file.name, error: error.message});
                            completedFiles++;
                        }
                    }

                    // Vis resultat
                    app.setLoadingState(false);
                    app.setProgress(100);

                    if (failedFiles.length === 0) {
                        app.showMessage(`‚úÖ Alle ${totalFiles} fakturaer ble lastet opp!`, 'success');
                    } else if (successfulFiles.length === 0) {
                        app.showMessage(`‚ùå Ingen fakturaer ble lastet opp. Sjekk filene og pr√∏v igjen.`, 'error');
                    } else {
                        const message = `üìä ${successfulFiles.length} av ${totalFiles} fakturaer ble lastet opp.\n\n` +
                            `‚úÖ Vellykkede: ${successfulFiles.join(', ')}\n\n` +
                            `‚ùå Feilet: ${failedFiles.map(f => f.name).join(', ')}`;
                        app.showMessage(message, 'success');
                    }
                });

                // Reset button
                document.getElementById('resetBtn').addEventListener('click', function() {
                    app.resetForm('uploadForm', {
                        onReset: () => {
                            // Reset selected files
                            selectedFiles = [];
                            document.getElementById('fileInfo').style.display = 'none';
                            document.querySelector('#submitBtn span').textContent = 'Send fakturaer';
                            
                            // Reset shipment count selection
                            document.querySelectorAll('.shipment-btn').forEach(btn => btn.classList.remove('selected'));
                            document.getElementById('shipmentCount').value = '';
                        }
                    });
                });

                // Standardisert mal info er alltid synlig siden det er eneste valg



                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                console.log('üìÑ TopLogic Fakturaopplasting er lastet');
                
            }, 100); // Redusert timeout
        });
    </script>
</body>
</html>
