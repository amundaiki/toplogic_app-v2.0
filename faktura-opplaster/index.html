<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopLogic - Fakturaopplasting</title>
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/67a10d12887082593bb5d293/d39dc0a0-5a17-4ef9-88a4-2d0edb45fd5e/LOGO+l.png?format=500w">
    <link rel="stylesheet" href="../shared.css">
</head>
<body>
    <div class="page-container">
        <div class="toplogic-container">
            <div class="toplogic-header">
                <img src="https://www.toplogic.no/wp-content/uploads/2023/01/Toplogic_norge_logo.svg" alt="TopLogic logo" class="header-logo" />
                <h1>Fakturaopplasting</h1>
                <p>Velg hvem som laster opp, velg leverand칮r og eventuelt hvilke parametre du 칮nsker 친 hente ut. Last deretter opp en PDF-faktura. Du vil motta en e-post med Excel-filen n친r prosesseringen er ferdig.</p>
            </div>
            
            <div class="toplogic-content">
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="opplaster" class="form-label">Hvem laster opp?</label>
                        <select id="opplaster" name="opplaster" class="form-select" required>
                            <option value="">Velg opplaster...</option>
                            <!-- Vil bli populert via JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="leverandor" class="form-label">Leverand칮r</label>
                        <select id="leverandor" name="leverandor" class="form-select" required>
                            <!-- Vil bli populert via JavaScript -->
                        </select>
                    </div>

                    <div class="form-group" id="paramGroup" style="display:none;">
                        <label for="parametre" class="form-label">Parametermodus</label>
                        <div class="toggle-group">
                            <button type="button" class="toggle-btn active" id="inkluderBtn">Inkluder</button>
                            <button type="button" class="toggle-btn" id="ekskluderBtn">Ekskluder</button>
                        </div>
                        <textarea id="parametre" name="parametre" class="form-textarea" rows="3" placeholder="f.eks. volum, antall, osv"></textarea>
                        <small style="color: var(--color-gray-medium); display: block; margin-top: var(--spacing-xs);">
                            Skriv inn hvilke parameter du 칮nsker 친 inkludere eller ekskludere fra analysen.<br>
                            Hvis du lar feltet st친 tomt, hentes alle parametre.
                        </small>
                        <input type="hidden" id="paramMode" name="paramMode" value="inkluder">
                    </div>

                    <div class="form-group">
                        <label for="fakturaFile" class="form-label">Last opp faktura</label>
                        <div class="file-upload-area" id="dropZone">
                            <input type="file" id="fakturaFile" name="fakturaFile" accept=".pdf" required>
                            <svg class="upload-icon" viewBox="0 0 24 24">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            <p><strong>Klikk for 친 velge fil</strong> eller dra og slipp her</p>
                            <p class="supported-formats">St칮ttet format: PDF</p>
                        </div>
                        <div class="file-info" id="fileInfo">
                            <p>Valgt fil: <span class="file-name" id="fileName"></span></p>
                        </div>
                    </div>

                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full btn-large" id="submitBtn">
                        <span>Send faktura</span>
                        <div class="loading-spinner" id="loadingSpinner"></div>
                    </button>

                    <button type="button" class="btn btn-secondary btn-full mt-lg" id="resetBtn">
                        Nullstill
                    </button>
                </form>

                <div class="message" id="message"></div>

                <!-- Info-seksjon -->
                <div style="margin-top: var(--spacing-xxxl); padding: var(--spacing-lg); background: var(--color-gray-light); border-radius: var(--radius-md);">
                    <h4 style="color: var(--color-gray-dark); margin-bottom: var(--spacing-md); font-size: var(--font-size-medium);">Hva skjer?</h4>
                    <ul style="color: var(--color-gray-medium); font-size: var(--font-size-normal); margin-left: var(--spacing-lg);">
                        <li>AI analyserer PDF-fakturaen automatisk</li>
                        <li>Ekstraherer alle relevante data og parametre</li>
                        <li>Konverterer til strukturert Excel-format</li>
                        <li>Sender resultatet til din e-post</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Last inn konfigurasjon og delt funksjonalitet -->
    <script src="../config.js"></script>
    <script src="../shared.js"></script>
    
    <script>
        // Initialiser TopLogic App
        const app = new TopLogicApp();
        const config = window.TopLogicConfig;

        // Populer dropdown-menyer fra config
        function populateDropdowns() {
            const opplasterSelect = document.getElementById('opplaster');
            const leverandorSelect = document.getElementById('leverandor');

            // Populer brukere
            config.APP_CONFIG.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.value;
                option.textContent = user.label;
                opplasterSelect.appendChild(option);
            });

            // Populer leverand칮rer
            config.APP_CONFIG.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.value;
                option.textContent = supplier.label;
                leverandorSelect.appendChild(option);
            });
        }

        // Initialiser komponenter
        populateDropdowns();

        // DOM elementer
        const leverandorSelect = document.getElementById('leverandor');
        const paramGroup = document.getElementById('paramGroup');
        const parametre = document.getElementById('parametre');
        const paramModeInput = document.getElementById('paramMode');
        const inkluderBtn = document.getElementById('inkluderBtn');
        const ekskluderBtn = document.getElementById('ekskluderBtn');

        // Vis/skjul parameterfelt basert p친 leverand칮rvalg
        leverandorSelect.addEventListener('change', function() {
            if (this.value === 'ingen') {
                paramGroup.style.display = 'block';
            } else {
                paramGroup.style.display = 'none';
                parametre.value = '';
            }
        });

        // Toggle-knapper for parametermodus
        inkluderBtn.addEventListener('click', function() {
            inkluderBtn.classList.add('active');
            ekskluderBtn.classList.remove('active');
            paramModeInput.value = 'inkluder';
        });

        ekskluderBtn.addEventListener('click', function() {
            ekskluderBtn.classList.add('active');
            inkluderBtn.classList.remove('active');
            paramModeInput.value = 'ekskluder';
        });

        // Setup file upload
        app.setupFileUpload('fakturaFile', {
            allowedTypes: 'pdf',
            onFileSelect: (file) => {
                console.log('Faktura valgt:', file.name);
            },
            onValidationError: (error) => {
                app.showMessage(error, 'error');
            }
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData();
            const opplaster = document.getElementById('opplaster').value;
            const leverandor = document.getElementById('leverandor').value;
            const file = document.getElementById('fakturaFile').files[0];
            const parametreValue = document.getElementById('parametre').value;
            const paramMode = document.getElementById('paramMode').value;

            // Valider required felter med config-meldinger
            if (!opplaster) {
                app.showMessage(config.APP_CONFIG.messages.error.noUser, 'error');
                return;
            }

            if (!leverandor) {
                app.showMessage(config.APP_CONFIG.messages.error.noSupplier, 'error');
                return;
            }

            if (!file) {
                app.showMessage(config.APP_CONFIG.messages.error.noFile, 'error');
                return;
            }

            // Valider fil
            if (!config.CONFIG_HELPERS.isValidFileSize(file)) {
                app.showMessage(config.APP_CONFIG.messages.error.fileTooBig, 'error');
                return;
            }

            if (!config.CONFIG_HELPERS.isValidFileType(file, 'pdf')) {
                app.showMessage(config.APP_CONFIG.messages.error.invalidFileType, 'error');
                return;
            }

            // Bygg FormData
            formData.append('file', file);
            formData.append('opplaster', opplaster);
            formData.append('leverandor', leverandor);
            formData.append('fileName', file.name);
            formData.append('timestamp', config.CONFIG_HELPERS.getTimestamp());

            if (leverandor === 'ingen') {
                formData.append('parametre', parametreValue);
                formData.append('paramMode', paramMode);
            }

            // Send til Make.com
            await app.submitForm(formData, 'faktura', {
                onStart: () => {
                    app.setLoadingState(true);
                    app.showMessage(config.APP_CONFIG.messages.info.uploading, 'success');
                },
                onProgress: (progress) => {
                    app.setProgress(progress);
                },
                onSuccess: (message) => {
                    app.showMessage(config.APP_CONFIG.messages.success.fakturaUploaded, 'success');
                    // Ikke nullstill automatisk - la brukeren bestemme
                },
                onError: (error) => {
                    app.showMessage(error, 'error');
                },
                onComplete: () => {
                    app.setLoadingState(false);
                }
            });
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            app.resetForm('uploadForm', {
                onReset: () => {
                    // Reset custom visibility og toggle states
                    paramGroup.style.display = 'none';
                    inkluderBtn.classList.add('active');
                    ekskluderBtn.classList.remove('active');
                    paramModeInput.value = 'inkluder';
                }
            });
        });

        // Vis parameterfelt ved lasting hvis "ingen" er valgt (f.eks. ved refresh)
        window.addEventListener('DOMContentLoaded', function() {
            if (leverandorSelect.value === 'ingen') {
                paramGroup.style.display = 'block';
            }
        });

        console.log('游늯 TopLogic Fakturaopplasting er lastet');
    </script>
</body>
</html>
